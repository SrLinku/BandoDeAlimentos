<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Doadores</title>
    <link rel="stylesheet" href="/css/theme.css" />
    <link rel="stylesheet" href="/css/layout.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.9/dist/inputmask.min.js"></script>
  </head>
  <body onload="ensureAuth()">
    <div class="layout">
      <aside class="sidebar collapsed">
        <div class="brand">
          <img src="/img/logo.png" alt="Logo" />
          <h1>Banco de Alimentos</h1>
        </div>
        <nav class="nav">
          <a href="/inicio"
            ><span class="ico"><i class="fa-solid fa-house"></i></span> InÃ­cio</a
          >
          <a href="/doacoes"
            ><span class="ico"><i class="fa-solid fa-gift"></i></span> DoaÃ§Ãµes</a
          >
          <a href="/estoque"
            ><span class="ico"><i class="fa-solid fa-warehouse"></i></span> Estoque</a
          >
          <a href="/doadores" class="active"
            ><span class="ico"><i class="fa-solid fa-users"></i></span> Doadores</a
          >
          <a href="/instituicoes"
            ><span class="ico"><i class="fa-solid fa-building-columns"></i></span> InstituiÃ§Ãµes</a
          >
          <a href="/relatorios"
            ><span class="ico"><i class="fa-solid fa-chart-line"></i></span> RelatÃ³rios</a
          >
        </nav>
      </aside>

      <main class="main">
        <div class="topbar">
          <div class="topbar-left">
            <button class="hamburger" id="btnHamburger" aria-label="Abrir menu">
              <i class="fa-solid fa-bars"></i>
            </button>
          </div>
          <button class="toggle" onclick="toggleTheme()">ðŸŒ—</button>
          <div class="avatar">U</div>
          <button id="btnLogout">Sair</button>
        </div>

        <div class="content">
          <div id="alerts"></div>

          <div class="card" style="margin-top: 8px">
            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center">
              <input id="searchByName" placeholder="Buscar por nome..." style="max-width: 340px" />
              <button class="ghost" id="btnClearSearch">Limpar</button>
            </div>
          </div>

          <div class="cards">
            <div class="card">
              <div class="title">Novos Doadores (30 dias)</div>
              <div class="value" id="kpi_novos_doadores">0</div>
            </div>
          </div>

          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center">
              <h2>Doadores</h2>
              <button onclick="document.getElementById('dlgForm').style.display='block'"><i class="fa-solid fa-plus"></i> Adicionar</button>
            </div>

            <table class="table" id="grid">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Tipo</th>
                  <th>Documento</th>
                  <th>Email</th>
                  <th>Telefone</th>
                  <th>AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="card" id="dlgForm" style="display: none" data-form="doador">
            <h3 id="formTitle">Novo Doador</h3>
            <div class="form-grid">
              <div><label>Nome</label><input id="d_nome" required /></div>
              <div>
                <label>Tipo</label>
                <select id="d_tipo">
                  <option>Pessoa JurÃ­dica</option>
                  <option>Pessoa FÃ­sica</option>
                </select>
              </div>
              <div><label>Documento</label><input id="d_documento" /></div>
              <div><label>Email</label><input id="d_email" type="email" /></div>
              <div><label>Telefone</label><input id="d_telefone" /></div>
            </div>
            <br />
            <button data-action="salvarDoador" onclick="salvar()">Salvar</button>
            <button class="secondary" onclick="cancelar()">Cancelar</button>
            <input type="hidden" id="d_id" />
          </div>

          <footer class="footer">Â© 2025 Banco de Alimentos de Londrina</footer>
        </div>
      </main>
    </div>

    <script src="/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/validation.js"></script>

    <script>
      async function carregar() {
        const novos = await api("/api/relatorios/novos-doadores");
        document.getElementById("kpi_novos_doadores").textContent = novos.qtd || 0;
        const dados = await api("/api/doadores");

        const grid = document.getElementById("grid");
        const tbody = grid.querySelector("tbody");
        tbody.innerHTML = "";

        for (const d of dados) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.id}</td>
            <td>${d.nome}</td>
            <td>${d.tipo || ""}</td>
            <td>${d.documento || ""}</td>
            <td>${d.email || ""}</td>
            <td>${d.telefone || ""}</td>
            <td>
              <button onclick="editar(${d.id}, '${d.nome.replace(/'/g, "\\'")}', '${(d.tipo || "").replace(/'/g, "\\'")}', '${(d.documento || "").replace(/'/g, "\\'")}', '${(d.email || "").replace(/'/g, "\\'")}', '${(d.telefone || "").replace(/'/g, "\\'")}')">
                <i class="fa-solid fa-pen"></i>
              </button>
              <button class="danger" onclick="excluir(${d.id})"><i class="fa-solid fa-trash"></i></button>
            </td>`;
          tbody.appendChild(tr);
        }

        inicializarBuscaPaginacao();
      }

      async function salvar() {
        const nome = d_nome.value.trim();
        if (!nome) return alertBox("error", "Nome Ã© obrigatÃ³rio");

        const payload = {
          nome,
          tipo: d_tipo.value,
          documento: d_documento.value,
          email: d_email.value,
          telefone: d_telefone.value,
        };

        try {
          if (d_id.value) {
            await api("/api/doadores/" + d_id.value, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
            alertBox("success", "Atualizado");
          } else {
            await api("/api/doadores", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            alertBox("success", "Cadastrado");
          }
          cancelar();
          carregar();
        } catch (e) {
          alertBox("error", e.message);
        }
      }

      function editar(id, nome, tipo, doc, email, tel) {
        d_id.value = id;
        d_nome.value = nome;
        d_tipo.value = tipo || "Pessoa JurÃ­dica";
        d_documento.value = doc || "";
        d_email.value = email || "";
        d_telefone.value = tel || "";
        formTitle.innerText = "Editar Doador";
        dlgForm.style.display = "block";
      }

      function cancelar() {
        d_id.value = "";
        d_nome.value = "";
        d_documento.value = "";
        d_email.value = "";
        d_telefone.value = "";
        formTitle.innerText = "Novo Doador";
        dlgForm.style.display = "none";
      }

      async function excluir(id) {
        if (confirm("Confirma excluir?")) {
          try {
            await api("/api/doadores/" + id, { method: "DELETE" });
            alertBox("success", "ExcluÃ­do");
            carregar();
          } catch (e) {
            alertBox("error", e.message);
          }
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        carregar();

        // MÃ¡scara CPF/CNPJ
        const tipo = document.getElementById("d_tipo");
        const doc = document.getElementById("d_documento");

        function aplicarMascaraDocumento() {
          const tipoSelecionado = tipo.value;
          if (tipoSelecionado === "Pessoa JurÃ­dica") {
            Inputmask({ mask: "99.999.999/9999-99" }).mask(doc);
          } else {
            Inputmask({ mask: "999.999.999-99" }).mask(doc);
          }
        }

        tipo.addEventListener("change", aplicarMascaraDocumento);
        aplicarMascaraDocumento();
      });

      // Busca + PaginaÃ§Ã£o
      function inicializarBuscaPaginacao() {
        const table = document.getElementById("grid");
        const searchInput = document.getElementById("searchByName");
        const clearBtn = document.getElementById("btnClearSearch");
        if (!table) return;
        const tbody = table.querySelector("tbody");
        const allRows = Array.from(tbody.querySelectorAll("tr"));
        let filtered = allRows.slice();
        let currentPage = 1;
        const pageSize = 8;
        let controls = table.nextElementSibling;
        if (!controls || !controls.classList || !controls.classList.contains("paginacao")) {
          controls = document.createElement("div");
          controls.className = "paginacao";
          table.after(controls);
        }
        function render() {
          allRows.forEach((r) => (r.style.display = "none"));
          const start = (currentPage - 1) * pageSize,
            end = start + pageSize;
          filtered.slice(start, end).forEach((r) => (r.style.display = ""));
          controls.innerHTML = "";
          const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
          for (let p = 1; p <= totalPages; p++) {
            const btn = document.createElement("button");
            btn.textContent = p;
            if (p === currentPage) btn.classList.add("active");
            btn.addEventListener("click", () => {
              currentPage = p;
              render();
            });
            controls.appendChild(btn);
          }
        }
        function applyFilter() {
          const term = (searchInput?.value || "").toLowerCase();
          filtered = term ? allRows.filter((r) => r.textContent.toLowerCase().includes(term)) : allRows.slice();
          currentPage = 1;
          render();
        }
        if (searchInput) {
          searchInput.removeEventListener("input", applyFilter);
          searchInput.addEventListener("input", applyFilter);
        }
        if (clearBtn) {
          clearBtn.onclick = () => {
            searchInput.value = "";
            applyFilter();
          };
        }
        render();
      }
    </script>
  </body>
</html>
